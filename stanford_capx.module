<?php
/**
 * @file
 * @author [author]
 *
 */

// Make sure this is loaded.
require_once "includes/autoloader.php";
require_once "includes/vendor/autoload.php";

use CAPx\APILib\HTTPClient;
use CAPx\Drupal\Importer\EntityImporter;
use CAPx\Drupal\Mapper\EntityMapper;

/**
 * Implements hook_help().
 */
function stanford_capx_help($path, $arg) {
  switch ($path) {
    case 'admin/capx':
      return '<p>' . t('Contact %email', array('%email' => l('email', 'mailto:no-reply@stanford.edu'))) . '</p>';
  }
}

/**
 * Implements hook_permission().
 */
function stanford_capx_permission() {
  return array(
    'administer capx' =>  array(
      'title' => t('Administer CAPx'),
      'description' => t('Administer and Configure CAPx settings.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function stanford_capx_menu() {

  $items['admin/config/capx'] = array(
    'title' => 'Administer CAPx',
    'page callback' => 'stanford_capx_admin_config',
    'access arguments' => array('administer capx'),
    'type' => MENU_SUGGESTED_ITEM,
  );

  return $items;
}

/**
 * [stanford_capx_admin_config description]
 * @return [type] [description]
 */
function stanford_capx_admin_config() {
  $output = "";

  // $client = new HTTPClient();
  // $response = $client->api('auth')->authenticate('xxx', 'xxx');
  // $token = $response->getAuthApiToken();

  // return $token;

  $token = '';

  $importer_config = array();
  $importer_config['type']    = "uids";
  $importer_config['values']  = array('sheamck','swberg','jbickar','cjwest','ptchen');

  $mapper_config = array();
  $mapper_config['entityType']  = 'node';
  $mapper_config['bundleType']  = 'stanford_person';
  $mapper_config['fields']      = array();
  $mapper_config['properties']  = array();

  // Patch the fields together
  $mapper_config['fields']['body']                            = '$.bio.html';
  $mapper_config['fields']['field_s_person_email']            = '$.alternateContact.email';
  $mapper_config['fields']['field_s_person_phone_display']    = '$.alternateContact.phoneNumbers[0]';
  $mapper_config['fields']['field_s_person_faculty_title']    = '$.education.*.degree';
  $mapper_config['fields']['field_s_person_first_name']       = '$.names.legal.firstName';
  $mapper_config['fields']['field_s_person_last_name']        = '$.names.legal.lastName';
  $mapper_config['fields']['field_s_person_profile_picture']  = '$.profilePhotos.bigger';

  // Put up the properties
  $mapper_config['properties']['title'] = '$.displayName';

  $mapper = new EntityMapper($mapper_config);

  $client = new HTTPClient();
  $client->setApiToken($token);

  $importer = new EntityImporter($importer_config, $mapper, $client);
  $importer->execute();

  return $output;
}
